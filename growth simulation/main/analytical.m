% 模拟生长的总程序
% 尝试解析解，还报错
% 甚至可以对参数和初值求导

clear;clc;clf;
% 参数
% 增长率，decay rate
r1=log(2)/30;
r2=log(2)/20;
m1=0.001;m2=0.001; 

% 半饱和值
Kc1=1;Kn1=9.31;Kp1=1.30; % 没确定
Kn2=9.31;Kp2=1.30;

% 转化速率，暂时认为和时间无关
% 芽孢呼吸，maintenance energy coefficient of 0.67 mmol glucose/g CDW/h
Re1=0.67e-3*12/60; 
% 蓝藻净光合，4.41+-0.16μmol(mg·min)，1000/54为光强
NPh=4.41e-3*12.01*tanh((1000/54)*0.016/4.41); 
% 蓝藻固氮,1.72+-0.25 fmol N/cell/h，细胞质量是估计的
Nf=1.72e-15*14.01/60/(1e-9); 
% 芽孢溶磷，无机+有机
Pf=8.87e-4+0; 

% Q值，假设为常数
%芽孢
Q1c=0.303; % 待定，能用
Q1n=0.0734;
Q1p=0.00607;
% 蓝藻
Q2c=0.2523; 
Q2n=0.0846;
Q2p=0.00248;

% 迭代变量，设定为初值
n1=1;n2=1;
% 沙丘
%rc=7.2e-3;rn=2.6e-4;rp=8.88e-5;
% 植被
rc=2.35e-2;rn=2.8e-4;rp=3.676e-4;

% f1_0=min([MM(rc, Kc1, n1), MM(rn, Kn1, n1), MM(rp, Kp1, n1)]);
% f2_0=min([MM(rn, Kn2, n2), MM(rp, Kp2, n2)]);
% G1_0=f1_0*r1*n1;si1_0=m1*n1;
% G2_0=f2_0*r2*n2;si2_0=m2*n2;

% 主变量和中间变量
syms t
syms N1(t) N2(t) Rc(t) Rn(t) Rp(t)
syms G1 G2 si1 si2 % si即是死
syms f1 f2 % MM

%% 模拟

% 老写法
% 别diff
% [N1 N2 Rc Rn Rp G1 G2 si1 si2 f1 f2]=dsolve(...
%     'G1=f1*r1*N1',...
%     'si1=m1*N1',...
%     'G2=f2*r2*N2',...
%     'si2=m2*N2',...
%     'f1=min([MM(Rc, Kc1, N1), MM(Rn, Kn1, N1), MM(Rp, Kp1, N1)])',...
%     'f2=min([MM(Rn, Kn2, N2), MM(Rp, Kp2, N2)])',...
%     'diff(N1)=G1-si1',...
%     'diff(N2)=G2-si2',...
%     'diff(Rc)=-Re1*N1+NPh*N2-Q1c*G1-Q2c*diff(N2)',...
%     'diff(Rn)=Nf*N2-Q1n*G1-Q2n*diff(N2)',...
%     'diff(Rp)=Pf*N1-Q1p*G1-Q2p*diff(N2)',...
%     'N1(0)=n1,N2(0)=n2,Rc(0)=rc,Rn(0)=rn,Rp(0)=rp,G1(0)=G1_0,G2(0)=G2_0,si1(0)=si1_0,si2(0)=si2_0,f1(0)=f1_0,f2(0)=f2_0',...
%     't');

% 新写法
% [N1 N2 Rc Rn Rp G1 G2 si1 si2 f1 f2]=dsolve(...
%     [G1 == f1 * r1 * N1,...
%     si1 == m1 * N1,...
%     G2 == f2 * r2 * N2,...
%     si2 == m2 * N2,...
%     f1 == min([MM(Rc, Kc1, N1), MM(Rn, Kn1, N1), MM(Rp, Kp1, N1)]),...
%     f2 == min([MM(Rn, Kn2, N2), MM(Rp, Kp2, N2)]),...
%     DN1 == G1 - si1,...
%     DN2 == G2 - si2,...
%     DRc == -Re1 * N1 + NPh * N2 - Q1c * G1 - Q2c * DN2,...
%     DRn == Nf * N2 - Q1n * G1 - Q2n * DN2,...
%     DRp == Pf * N1 - Q1p * G1 - Q2p * DN2],...
%     [N1(0)==n1,N2(0)==n2,Rc(0)==rc,Rn(0)==rn,Rp(0)==rp,G1(0)==G1_0,G2(0)==G2_0,si1(0)==si1_0,si2(0)==si2_0,f1(0)==f1_0,f2(0)==f2_0])

%% 单个限制
% [N1 N2 Rn G1 G2 si1 si2 f1 f2]=dsolve(...
%     [diff(N1)==G1-si1,...
%     diff(N2)==G2-si2,...
%     diff(Rn)==Nf*N2-Q1n*G1-Q2n*diff(N2),...
%     G1==f1*r1*N1,...
%     si1==m1*N1,...
%     G2==f2*r2*N2,...
%     si2==m2*N2,...
%     f1==MM(Rn, Kn1, N1),...
%     f2==MM(Rn, Kn2, N2)]...
%     );
%     ,[N1(0)==n1,N2(0)==n2,Rn(0)==rn,G1(0)==G1_0,G2(0)==G2_0,si1(0)==si1_0,si2(0)==si2_0,f1(0)==f1_0,f2(0)==f2_0]);

% [N1 N2 Rn f1 f2]=dsolve(...
%     [diff(N1)==f1*r1*N1-m1*N1,...
%     diff(N2)==f2*r2*N2-m2*N2,...
%     diff(Rn)==Nf*N2-Q1n*f1*r1*N1-Q2n*diff(N2),...
%     f1==Rn/(Rn+Kn1*N1),...
%     f2==Rn/(Rn+Kn2*N2)]...
%     ); 

[N1 N2 Rn]=dsolve(...
    [diff(N1)==Rn/(Rn+Kn1*N1)*r1*N1-m1*N1,...
    diff(N2)==Rn/(Rn+Kn2*N2)*r2*N2-m2*N2,...
    diff(Rn)==Nf*N2-Q1n*Rn/(Rn+Kn1*N1)*r1*N1-Q2n*diff(N2)]); 


%% 互相抑制
syms N1 N2 ga1 ga2 r1 r2 
[N1 N2]=dsolve(...
    [diff(N1)==r1*N1*(1-ga1*N1*N2),...
    diff(N2)==r2*N2*(1-ga2*N1*N2)]);




